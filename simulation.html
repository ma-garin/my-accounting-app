<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>金額シミュレーション</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">

  <style>
    body {
      font-family: 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 15px;
      background-color: #f9f9f9;
      color: #333;
      padding-bottom: 70px; /* 下部ボタンのためのスペース */
      position: relative;
      line-height: 1.5; /* 行の高さを調整 */
    }
    h2, h3, h4 {
      text-align: center;
      margin-top: 20px;
      margin-bottom: 15px;
      color: #0056b3; /* タイトル色 */
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 15px;
      overflow-x: hidden;
    }

    /* 各セクションの余白調整 */
    #simulationSetTable, #simulationDrinkTable, #addMoreSimDrink {
      margin-bottom: 25px;
    }

    /* === テーブルの基本スタイル === */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #e2e2e2;
      color: #555;
    }

    /* ボタンのスタイル */
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease;
      white-space: nowrap;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:active {
      background-color: #004085;
    }

    .btns {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
    }

    .btns button {
      padding: 5px 10px;
      font-size: 0.9rem;
    }

    .btns span {
      min-width: 20px;
      text-align: center;
      font-weight: bold;
    }

    /* === シミュレーション設定 === */
    .sim-settings {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin-bottom: 20px;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .sim-settings label {
      font-weight: bold;
      color: #555;
    }

    .sim-settings input[type="number"] {
      width: 60px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: right;
    }

    /* === 会計サマリーテーブル === */
    .summary-table td:nth-child(1) {
      text-align: left;
      font-weight: bold;
      color: #555;
    }
    .summary-table td:nth-child(2) {
      text-align: right;
      font-weight: bold;
      color: #333;
    }

    /* === カスタムドリンク === */
    .new-drink-row input[type="text"] {
        width: 80%;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .new-drink-row input[type="number"] {
        width: 60px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: right;
    }

    /* 下部固定ボタン */
    .fixed-bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #f0f0f0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      padding: 10px 15px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-sizing: border-box;
      z-index: 1000;
      max-width: 500px;
      left: 50%;
      transform: translateX(-50%);
    }

    .fixed-bottom-bar button {
      width: 48%;
      padding: 12px 0;
      font-size: 1.1rem;
    }

    /* 現在の総計を強調 */
    #sim_grand_total {
      text-align: center;
      font-size: 2.2rem;
      color: #d32f2f;
      padding: 15px 0;
      background-color: #ffe0b2;
      border-radius: 8px;
      margin-top: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* PWA更新通知バー */
    #updateNotification {
      display: none;
      text-align: center;
      padding: 10px;
      background-color: #ffeb3b;
      color: #333;
      margin-top: 20px;
      border-radius: 8px;
      font-weight: bold;
    }

    #updateNotification button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      margin-left: 10px;
      cursor: pointer;
    }

    /* レスポンシブ対応 */
    @media (min-width: 600px) {
      .container {
        padding: 25px;
      }
      .fixed-bottom-bar {
        width: 500px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h2>金額シミュレーション</h2>
    </header>

    <div id="updateNotification">
      新しいバージョンがあります！ <button id="updateButton">今すぐ更新</button>
    </div>

    <main>
      <section id="simulationTotalSection">
        <h3>シミュレーション合計金額</h3>
        <p id="sim_grand_total"><strong>0円</strong></p>
      </section>

      <section id="simulationSettings">
        <h3>シミュレーション設定</h3>
        <div class="sim-settings">
          <label for="sim_hours">時間(h):</label>
          <input type="number" id="sim_hours" value="1" min="0">
          <label for="sim_minutes">分(m):</label>
          <input type="number" id="sim_minutes" value="0" min="0" max="59">
        </div>
      </section>

      <section id="simulationDrinkAccount">
        <h3>ドリンク会計</h3>
        <table id="simulationDrinkTable">
          <thead>
            <tr>
              <th>項目</th>
              <th>価格</th>
              <th>数量</th>
              <th>合計</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Lドリンク</td>
              <td>1700円</td>
              <td>
                <div class="btns">
                  <button data-item="ldrink" data-delta="1">+</button>
                  <span id="sim_ldrink_qty">0</span>
                  <button data-item="ldrink" data-delta="-1">-</button>
                </div>
              </td>
              <td id="sim_ldrink_total">0円</td>
            </tr>
            <tr>
              <td>メガドリンク</td>
              <td>3700円</td>
              <td>
                <div class="btns">
                  <button data-item="megadrink" data-delta="1">+</button>
                  <span id="sim_megadrink_qty">0</span>
                  <button data-item="megadrink" data-delta="-1">-</button>
                </div>
              </td>
              <td id="sim_megadrink_total">0円</td>
            </tr>
            <tr>
              <td>SHOT</td>
              <td>1500円</td>
              <td>
                <div class="btns">
                  <button data-item="shot" data-delta="1">+</button>
                  <span id="sim_shot_qty">0</span>
                  <button data-item="shot" data-delta="-1">-</button>
                </div>
              </td>
              <td id="sim_shot_total">0円</td>
            </tr>
            <tr>
              <td>ゲストSHOT</td>
              <td>1000円</td>
              <td>
                <div class="btns">
                  <button data-item="guestshot" data-delta="1">+</button>
                  <span id="sim_guestshot_qty">0</span>
                  <button data-item="guestshot" data-delta="-1">-</button>
                </div>
              </td>
              <td id="sim_guestshot_total">0円</td>
            </tr>
            <tr>
              <td>カラオケ5曲</td>
              <td>1000円</td>
              <td>
                <div class="btns">
                  <button data-item="karaoke" data-delta="1">+</button>
                  <span id="sim_karaoke_qty">0</span>
                  <button data-item="karaoke" data-delta="-1">-</button>
                </div>
              </td>
              <td id="sim_karaoke_total">0円</td>
            </tr>
          </tbody>
        </table>

        <h4>カスタムドリンク</h4>
        <table id="addMoreSimDrink">
          <thead>
            <tr>
              <th>ドリンク名</th>
              <th>金額</th>
              <th>数量</th>
              <th>合計</th>
            </tr>
          </thead>
          <tbody id="newSimDrinkRows">
            </tbody>
        </table>
        <div class="quick-add-buttons" style="text-align: center;">
          <button id="addNewSimDrinkRowButton">カスタムドリンク追加</button>
        </div>
      </section>

      <section id="summaryAccount">
        <h3>会計サマリー</h3>
        <table class="summary-table">
          <tr>
            <td>セット合計</td>
            <td id="sim_set_sum">0円</td>
          </tr>
          <tr>
            <td>ドリンク合計</td>
            <td id="sim_drink_sum">0円</td>
          </tr>
          <tr>
            <td>小計</td>
            <td id="sim_subtotal_summary">0円</td>
          </tr>
          <tr>
            <td>サービス料(10%)</td>
            <td id="sim_service">0円</td>
          </tr>
          <tr>
            <td>消費税(10%)</td>
            <td id="sim_tax">0円</td>
          </tr>
          <tr>
            <td>合計金額</td>
            <td id="sim_grand_total_summary"><strong>0円</strong></td>
          </tr>
        </table>
      </section>

      <section id="menuLink" style="text-align: center; margin-top: 30px;">
        <p><a href="menu.html">メニュー画面へ</a></p>
      </section>
    </main>
  </div>

  <div class="fixed-bottom-bar">
    <button id="resetSimulationButton">すべてリセット</button>
    <button onclick="window.location.href='menu.html'">メニュー画面</button>
  </div>

  <script>
    // 即時関数でスコープを隔離
    (function() {
      // === 定数定義 ===
      const SET_DURATION_MINUTES = 40;
      const MS_PER_SECOND = 1000;
      const MS_PER_MINUTE = 60 * MS_PER_SECOND;
      const MS_PER_HOUR = 60 * MS_PER_MINUTE;
      const SET_DURATION_MS = SET_DURATION_MINUTES * MS_PER_MINUTE;

      const MAX_NEW_DRINKS = 5; // 追加できるカスタムドリンクの最大数
      const SERVICE_CHARGE_RATE = 0.10; // サービス料率
      const TAX_RATE = 0.10; // 消費税率

      // === DOM要素のキャッシュ ===
      const simHoursInput = document.getElementById('sim_hours');
      const simMinutesInput = document.getElementById('sim_minutes');

      const simGrandTotalElement = document.getElementById('sim_grand_total');
      const simSetSumElement = document.getElementById('sim_set_sum');
      const simDrinkSumElement = document.getElementById('sim_drink_sum');
      const simSubtotalSummaryElement = document.getElementById('sim_subtotal_summary');
      const simServiceElement = document.getElementById('sim_service');
      const simTaxElement = document.getElementById('sim_tax');
      const simGrandTotalSummaryElement = document.getElementById('sim_grand_total_summary');
      const newSimDrinkRowsContainer = document.getElementById('newSimDrinkRows');

      const updateNotification = document.getElementById('updateNotification');
      const updateButton = document.getElementById('updateButton');

      // === 状態変数 ===
      // set1とset2は自動計算のみで使用するため、pricesから削除し、setPriceA/Bを直接使用
      const simPrices = { ldrink: 1700, megadrink: 3700, shot: 1500, guestshot: 1000, karaoke: 1000 };
      const simQuantities = { ldrink: 0, megadrink: 0, shot: 0, guestshot: 0, karaoke: 0 };
      let newSimDrinkCount = 0; // 現在追加されているカスタムドリンクの数
      let newSimDrinkIds = []; // カスタムドリンクのIDを管理する配列

      // === ヘルパー関数 ===

      /**
       * 数値を3桁区切りでフォーマットする
       * @param {number} num
       * @returns {string} フォーマットされた文字列
       */
      function formatNumber(num) {
        return num.toLocaleString();
      }

      // === 主なロジック関数 ===

      /**
       * シミュレーション用ドリンクの数量を調整し、表示を更新する
       * @param {string} item - アイテムID (ldrink, shot など)
       * @param {number} delta - 変更量 (+1 または -1)
       */
      function adjustSimQuantity(item, delta) {
        simQuantities[item] = Math.max(0, simQuantities[item] + delta);
        updateSimItemDisplay(item);
        calculateSimTotal();
      }

      /**
       * 特定のシミュレーション用アイテムの数量と合計金額の表示を更新する
       * @param {string} item - アイテムID
       */
      function updateSimItemDisplay(item) {
        const qtyElement = document.getElementById(`sim_${item}_qty`);
        const totalElement = document.getElementById(`sim_${item}_total`);
        if (qtyElement) qtyElement.innerText = simQuantities[item];
        if (totalElement) totalElement.innerText = `${formatNumber(simPrices[item] * simQuantities[item])}円`;
      }

      /**
       * シミュレーションの合計金額を計算し表示を更新する
       */
      function calculateSimTotal() {
        const simHours = parseInt(simHoursInput.value) || 0;
        const simMinutes = parseInt(simMinutesInput.value) || 0;
        const totalSimMinutes = simHours * 60 + simMinutes;

        // シミュレーションでのセット数
        const simSetCount = Math.floor(totalSimMinutes / SET_DURATION_MINUTES) + 1;
        const effectiveSimSetCount = Math.max(1, simSetCount); // 最低1セットは保証

        // セットAとセットBの固定価格
        const SET_PRICE_A = 2500; // 1セット目の料金
        const SET_PRICE_B = 3000; // 2セット目以降の料金

        let calculatedSimSetTotal = 0;
        if (effectiveSimSetCount >= 1) {
          calculatedSimSetTotal = SET_PRICE_A + (effectiveSimSetCount - 1) * SET_PRICE_B;
        }

        let simDrinkTotal = 0;
        // 標準ドリンクの合計
        simDrinkTotal += simPrices.ldrink * simQuantities.ldrink;
        simDrinkTotal += simPrices.megadrink * simQuantities.megadrink;
        simDrinkTotal += simPrices.shot * simQuantities.shot;
        simDrinkTotal += simPrices.guestshot * simQuantities.guestshot;
        simDrinkTotal += simPrices.karaoke * simQuantities.karaoke;

        // カスタムドリンクの合計
        newSimDrinkIds.forEach(id => {
          simDrinkTotal += (simPrices[id] || 0) * (simQuantities[id] || 0);
          updateSimItemDisplay(id); // カスタムドリンクも表示更新
        });

        const simSubtotal = calculatedSimSetTotal + simDrinkTotal; // 小計
        const simService = Math.floor(simSubtotal * SERVICE_CHARGE_RATE); // サービス料
        const simSubtotalWithService = simSubtotal + simService;
        const simTax = Math.floor(simSubtotalWithService * TAX_RATE); // 消費税
        let simFinalTotal = simSubtotalWithService + simTax;

        // 百円単位四捨五入
        simFinalTotal = Math.round(simFinalTotal / 100) * 100;

        // シミュレーション画面の表示更新
        simGrandTotalElement.innerHTML = `<strong>${formatNumber(simFinalTotal)}円</strong>`;

        // シミュレーションサマリーテーブルの表示更新
        simSetSumElement.innerText = `${formatNumber(calculatedSimSetTotal)}円`;
        simDrinkSumElement.innerText = `${formatNumber(simDrinkTotal)}円`;
        simSubtotalSummaryElement.innerText = `${formatNumber(simSubtotal)}円`;
        simServiceElement.innerText = `${formatNumber(simService)}円`;
        simTaxElement.innerText = `${formatNumber(simTax)}円`;
        simGrandTotalSummaryElement.innerHTML = `<strong>${formatNumber(simFinalTotal)}円</strong>`;
      }

      /**
       * 新しいカスタムドリンク行を追加する (シミュレーション用)
       */
      function addNewSimDrinkRow() {
        if (newSimDrinkCount < MAX_NEW_DRINKS) {
          newSimDrinkCount++;
          const newId = `newsimdrink${newSimDrinkCount}`;
          newSimDrinkIds.push(newId);
          // 新しいドリンクの価格と数量を初期化
          simPrices[newId] = 0;
          simQuantities[newId] = 0;

          const newRow = document.createElement('tr');
          newRow.className = 'new-drink-row';
          newRow.innerHTML = `
            <td><input type="text" id="${newId}_name" placeholder="ドリンク名"></td>
            <td><input type="number" id="${newId}_price" placeholder="金額" min="0">円</td>
            <td>
              <div class="btns">
                <button data-item="${newId}" data-delta="1">+</button>
                <span id="sim_${newId}_qty">0</span>
                <button data-item="${newId}" data-delta="-1">-</button>
              </div>
            </td>
            <td id="sim_${newId}_total">0円</td>
          `;
          newSimDrinkRowsContainer.appendChild(newRow);

          // イベントリスナーを動的に追加
          const newPriceInput = document.getElementById(`${newId}_price`);
          newPriceInput.addEventListener('input', () => updateNewSimDrinkPrice(newId));

          // 追加した行内の +/- ボタンにもイベントリスナーを設定
          const buttons = newRow.querySelectorAll('.btns button');
          buttons.forEach(button => {
            button.addEventListener('click', (event) => {
              const item = event.target.dataset.item;
              const delta = parseInt(event.target.dataset.delta);
              adjustNewSimDrink(item, delta);
            });
          });
        } else {
          alert(`追加できるカスタムドリンクは${MAX_NEW_DRINKS}個までです。`);
        }
      }

      /**
       * カスタムドリンクの金額入力時の処理 (シミュレーション用)
       * @param {string} id - カスタムドリンクID
       */
      function updateNewSimDrinkPrice(id) {
        const priceInput = document.getElementById(`${id}_price`);
        const price = parseInt(priceInput.value);
        if (!isNaN(price) && price >= 0) {
          simPrices[id] = price;
        } else {
          simPrices[id] = 0; // 不正な入力の場合は0に設定
          priceInput.value = ''; // 入力値をクリア
        }
        calculateSimTotal(); // 価格が変更されたら合計を再計算
      }

      /**
       * カスタムドリンクの数量調整 (シミュレーション用)
       * @param {string} id - カスタムドリンクID
       * @param {number} delta - 変更量 (+1 または -1)
       */
      function adjustNewSimDrink(id, delta) {
        const priceInput = document.getElementById(`${id}_price`);
        const price = parseInt(priceInput.value);

        if (isNaN(price) || price < 0) {
          if (delta > 0) {
            alert('カスタムドリンクの金額を半角数字で入力してください。');
            priceInput.focus();
            return;
          }
        }
        simPrices[id] = !isNaN(price) && price >= 0 ? price : (simPrices[id] || 0);

        if (typeof simQuantities[id] === 'undefined') {
          simQuantities[id] = 0;
        }
        simQuantities[id] = Math.max(0, simQuantities[id] + delta);

        updateSimItemDisplay(id);
        calculateSimTotal();
      }

      /**
       * シミュレーションの全てをリセットする
       */
      function resetSimulation() {
        simHoursInput.value = 1;
        simMinutesInput.value = 0;

        Object.keys(simQuantities).forEach(key => {
          if (simPrices.hasOwnProperty(key)) {
            simQuantities[key] = 0;
            updateSimItemDisplay(key);
          }
        });

        newSimDrinkIds.forEach(id => {
          delete simPrices[id];
          delete simQuantities[id];
        });
        newSimDrinkIds = [];
        newSimDrinkCount = 0;
        newSimDrinkRowsContainer.innerHTML = '';

        calculateSimTotal();
      }

      /**
       * Service Workerの更新通知バーを表示する
       */
      let serviceWorkerNewWorker;

      function showUpdateBar() {
        if (updateNotification && updateButton) {
          updateNotification.style.display = 'block';
          updateButton.addEventListener('click', () => {
            if (serviceWorkerNewWorker) {
              serviceWorkerNewWorker.postMessage({ action: 'skipWaiting' });
            }
          });
        }
      }

      /**
       * イベントリスナーの登録
       */
      function registerEventListeners() {
        // iPhone向け：ダブルタップズームを抑制
        document.addEventListener('touchend', function(event) {
            if (event.detail > 1) {
                event.preventDefault();
            }
        }, { passive: false });

        // 時間入力の変更を検知
        simHoursInput.addEventListener('input', calculateSimTotal);
        simMinutesInput.addEventListener('input', calculateSimTotal);

        // ドリンク数量調整ボタン (イベント委譲)
        document.getElementById('simulationDrinkTable').addEventListener('click', (event) => {
          const button = event.target.closest('button[data-item]');
          if (button) {
            const item = button.dataset.item;
            const delta = parseInt(button.dataset.delta);
            adjustSimQuantity(item, delta);
          }
        });

        // カスタムドリンク追加ボタン
        document.getElementById('addNewSimDrinkRowButton').addEventListener('click', addNewSimDrinkRow);

        // 全てリセットボタン
        document.getElementById('resetSimulationButton').addEventListener('click', resetSimulation);

        // Service Workerの登録
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
              .then(reg => {
                console.log('ServiceWorker registration successful with scope: ', reg.scope);

                reg.addEventListener('updatefound', () => {
                  serviceWorkerNewWorker = reg.installing;

                  serviceWorkerNewWorker.addEventListener('statechange', () => {
                    if (serviceWorkerNewWorker.state === 'installed') {
                      if (navigator.serviceWorker.controller) {
                        showUpdateBar();
                      }
                    }
                  });
                });
              })
              .catch(err => {
                console.log('ServiceWorker registration failed: ', err);
              });

            navigator.serviceWorker.addEventListener('controllerchange', () => {
              window.location.reload();
            });
          });
        }
      }

      // === 初期化処理 ===
      document.addEventListener('DOMContentLoaded', () => {
        registerEventListeners();
        calculateSimTotal(); // 初期表示の計算
      });

    })(); // 即時関数の終わり
  </script>
</body>
</html>